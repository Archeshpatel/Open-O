<!--  
/*
 * 
 * Copyright (c) 2001-2002. Department of Family Medicine, McMaster University. All Rights Reserved. *
 * This software is published under the GPL GNU General Public License. 
 * This program is free software; you can redistribute it and/or 
 * modify it under the terms of the GNU General Public License 
 * as published by the Free Software Foundation; either version 2 
 * of the License, or (at your option) any later version. * 
 * This program is distributed in the hope that it will be useful, 
 * but WITHOUT ANY WARRANTY; without even the implied warranty of 
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the 
 * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License 
 * along with this program; if not, write to the Free Software 
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA. * 
 * 
 * <OSCAR TEAM>
 * 
 * This software was written for the 
 * Department of Family Medicine 
 * McMaster Unviersity 
 * Hamilton 
 * Ontario, Canada 
 */
-->

<%@ taglib uri="/WEB-INF/msg-tag.tld" prefix="oscarmessage" %>
<%@ page import="java.lang.*, java.util.*, java.text.*,java.sql.*,java.net.*, oscar.*" errorPage="errorpage.jsp" %>
<%
  if(session.getValue("user") == null || !((String) session.getValue("userprofession")).equalsIgnoreCase("receptionist"))
    response.sendRedirect("../logout.jsp");
    
  String curUser_no,userfirstname,userlastname, userprofession, mygroupno;
  curUser_no = (String) session.getAttribute("user");
  mygroupno = (String) session.getAttribute("groupno");  
  userfirstname = (String) session.getAttribute("userfirstname");
  userlastname = (String) session.getAttribute("userlastname");
  userprofession = (String) session.getAttribute("userprofession");
  int startHour=Integer.parseInt((String) session.getAttribute("starthour"));
  int endHour=Integer.parseInt((String) session.getAttribute("endhour"));
  int everyMin=Integer.parseInt((String) session.getAttribute("everymin"));
  int view=0;
  int lenLimitedL=11, lenLimitedS=3;
  int len = lenLimitedL;
  if(request.getParameter("view")!=null) view=Integer.parseInt(request.getParameter("view")); //0-multiple views, 1-single view
%>
<jsp:useBean id="apptMainBean" class="oscar.AppointmentMainBean" scope="session" />
<jsp:useBean id="DateTimeCodeBean" class="java.util.Hashtable" scope="page" />
<jsp:useBean id="providerBean" class="java.util.Properties" scope="session" />
<%
  String resourcebaseurl = "http://67.69.12.117:8080/oscarResource/";
  ResultSet rsgroup1 = apptMainBean.queryResults("resource_baseurl", "search_resource_baseurl");
  while (rsgroup1.next()) { 
 	  resourcebaseurl = rsgroup1.getString("value");
  }

  GregorianCalendar now=new GregorianCalendar();
  int curYear = now.get(Calendar.YEAR);
  int curMonth = (now.get(Calendar.MONTH)+1);
  int curDay = now.get(Calendar.DAY_OF_MONTH);
  int year = Integer.parseInt(request.getParameter("year"));
  int month = Integer.parseInt(request.getParameter("month"));
  int day = Integer.parseInt(request.getParameter("day"));
  String strYear=null, strMonth=null, strDay=null;
  String strDayOfWeek=null;
  String[] arrayDayOfWeek = new String[] { "Sun","Mon","Tue","Wed","Thu","Fri","Sat"  };

  //verify the input date is really existed 
  now=new GregorianCalendar(year,(month-1),day);
  year = now.get(Calendar.YEAR);
  month = (now.get(Calendar.MONTH)+1);
  day = now.get(Calendar.DAY_OF_MONTH);
  int dayOfWeek = now.get(Calendar.DAY_OF_WEEK);
  strDayOfWeek=arrayDayOfWeek[dayOfWeek-1];
  strYear=""+year;
  strMonth=month>9?(""+month):("0"+month);
  strDay=day>9?(""+day):("0"+day);
%>

<html>
<head>
<title>Receptionist Appointment Access</title>
<link rel="stylesheet" href="receptionistapptstyle.css" type="text/css">
      <meta http-equiv="expires" content="Mon,12 May 1998 00:36:05 GMT">
      <meta http-equiv="Pragma" content="no-cache">
</head>
<script language="JavaScript">
<!--
function setfocus() {
  this.focus();
  document.findprovider.providername.focus();
  document.findprovider.providername.select();
}
function popupPage(vheight,vwidth,varpage) { //open a new popup window
  var page = "" + varpage;
  windowprops = "height="+vheight+",width="+vwidth+",location=no,scrollbars=yes,menubars=no,toolbars=no,resizable=yes,top=0,left=0";//360,680
  var popup=window.open(page, "apptReception", windowprops);
  if (popup != null) {
    if (popup.opener == null) {
      popup.opener = self; 
    }
  }
}
function popupPage2(varpage) {
var page = "" + varpage;
windowprops = "height=700,width=1000,location=no,"
+ "scrollbars=yes,menubars=no,toolbars=no,resizable=yes,top=15,left=10";
window.open(page, "apptReceptionSearch", windowprops);
}

function popupOscarRx(vheight,vwidth,varpage) { //open a new popup window
  var page = varpage;
  windowprops = "height="+vheight+",width="+vwidth+",location=no,scrollbars=yes,menubars=no,toolbars=no,resizable=yes,screenX=0,screenY=0,top=0,left=0";
  var popup=window.open(varpage, "oscarRx", windowprops);
  if (popup != null) {
    if (popup.opener == null) {
      popup.opener = self;
    }
  }
}

function review(key) {
  if(self.location.href.lastIndexOf("&viewall=") > 0 ) a = self.location.href.substring(0,self.location.href.lastIndexOf("&viewall="));
  else a = self.location.href;

	self.location.href = a + "&viewall="+key ;
}

function refresh() {
  history.go(0);
}
function refresh1() {
  var u = self.location.href;
  if(u.lastIndexOf("view=1") > 0) {
    self.location.href = u.substring(0,u.lastIndexOf("view=1")) + "view=0" + u.substring(eval(u.lastIndexOf("view=1")+6));
  } else {
    history.go(0);
  }
}
function changeGroup(s) {
	var newGroupNo = s.options[s.selectedIndex].value;
	if(newGroupNo.indexOf("_grp_") != -1) {
	  newGroupNo = s.options[s.selectedIndex].value.substring(5);
	  popupPage(10,10, "receptionistcontrol.jsp?provider_no=<%=curUser_no%>&start_hour=<%=startHour%>&end_hour=<%=endHour%>&every_min=<%=everyMin%>&color_template=deepblue&dboperation=updatepreference&displaymode=updatepreference&mygroup_no="+newGroupNo);
	} else {
	  newGroupNo = s.options[s.selectedIndex].value;
	  popupPage(10,10, "receptionistcontrol.jsp?provider_no=<%=curUser_no%>&start_hour=<%=startHour%>&end_hour=<%=endHour%>&every_min=<%=everyMin%>&color_template=deepblue&dboperation=updatepreference&displaymode=updatepreference&mygroup_no="+newGroupNo);
	}
}
function ts1(s) {
  popupPage(360,680,('../appointment/addappointment.jsp?'+s));
}
function tsr(s) {
  popupPage(360,680,('../appointment/appointmentcontrol.jsp?displaymode=edit&dboperation=search&'+s)); 
}
function goFilpView(s) {
	self.location.href = "../schedule/scheduleflipview.jsp?originalpage=../receptionist/receptionistcontrol.jsp&startDate=<%=year+"-"+month+"-"+day%>" + "&provider_no="+s ;
}
function goZoomView(s, n) {
	self.location.href = "receptionistcontrol.jsp?year=<%=strYear%>&month=<%=strMonth%>&day=<%=strDay%>&view=1&curProvider="+s+"&curProviderName="+n+"&displaymode=day&dboperation=searchappointmentday" ;
}
function findProvider(p,m,d) {
  popupPage(300,400, "receptionistfindprovider.jsp?pyear=" +p+ "&pmonth=" +m+ "&pday=" +d+ "&providername="+ document.findprovider.providername.value );
}
//-->
</SCRIPT>
<body background="../images/gray_bg.jpg" bgproperties="fixed" onLoad="setfocus()" topmargin="0" leftmargin="0" rightmargin="0">

<%
   int numProvider=0, numAvailProvider=0;
   String [] curProvider_no;
   String [] curProviderName;
   ResultSet rsgroup = null;
  
   //initial provider bean for all the application
   if(providerBean.isEmpty()) {
     rsgroup = apptMainBean.queryResults("last_name", "searchallprovider");
 	   while (rsgroup.next()) { 
 	    providerBean.setProperty(rsgroup.getString("provider_no"), new String( rsgroup.getString("last_name")+","+rsgroup.getString("first_name") ));
 	   }
 	 }
   
   if(providerBean.get(mygroupno) != null) { //single appointed provider view
     numProvider=1;
     curProvider_no = new String [numProvider];
     curProviderName = new String [numProvider];
     curProvider_no[0]=mygroupno;
     curProviderName[0]=providerBean.getProperty(mygroupno);
   } else {
    if(view==0) { //multiple views
	   rsgroup = apptMainBean.queryResults(mygroupno, "searchmygroupcount");
 	   while (rsgroup.next()) { 
       numProvider=rsgroup.getInt("count(provider_no)");
     }

     if(session.getAttribute(mygroupno+"_$navailprovider")!=null) {
       numAvailProvider = Integer.parseInt((String) session.getAttribute(mygroupno+"_$navailprovider")) ;
     } else {
       String [] param3 = new String [2];
       param3[0] = mygroupno;
       param3[1] = strYear +"-"+ strMonth +"-"+ strDay ;
  	   rsgroup = apptMainBean.queryResults(param3, "search_numgrpscheduledate");
 	     while (rsgroup.next()) { 
         numAvailProvider = rsgroup.getInt("count(scheduledate.provider_no)");
       }
       session.setAttribute(mygroupno+"_$navailprovider", ""+numAvailProvider);
     }
       if(request.getParameter("viewall")!=null && request.getParameter("viewall").equals("1") ) {
         if(numProvider >= 5) {lenLimitedL = 3; lenLimitedS = 2; }
       } else {
         if(numAvailProvider >= 5) {lenLimitedL = 3; lenLimitedS = 2; }
       }

     curProvider_no = new String [numProvider];
     curProviderName = new String [numProvider];

	   rsgroup = apptMainBean.queryResults(mygroupno, "searchmygroupprovider");
	   int iTemp=0;
     while (rsgroup.next()) { 
       curProvider_no[iTemp]=rsgroup.getString("provider_no");
       curProviderName[iTemp]=rsgroup.getString("first_name")+" "+rsgroup.getString("last_name");
       iTemp++;
     }
    } else { //single view
     numProvider=1;
     curProvider_no = new String [numProvider];
     curProviderName = new String [numProvider];
     curProvider_no[0]=request.getParameter("curProvider");
     curProviderName[0]=request.getParameter("curProviderName");
    }
   }
   
   //set timecode bean
   String bgcolordef = "#FFFFE0" ;
   String [] param3 = new String[2];
   param3[0] = strYear+"-"+strMonth+"-"+strDay;
   for(int nProvider=0;nProvider<numProvider;nProvider++) {
     param3[1] = curProvider_no[nProvider];
	   rsgroup = apptMainBean.queryResults(param3, "search_appttimecode");
     while (rsgroup.next()) { 
       DateTimeCodeBean.put(rsgroup.getString("provider_no"), rsgroup.getString("timecode"));
     } 
   }
	 rsgroup = apptMainBean.queryResults("code", "search_timecode");
   while (rsgroup.next()) { 
     DateTimeCodeBean.put("description"+rsgroup.getString("code"), rsgroup.getString("description"));
     DateTimeCodeBean.put("duration"+rsgroup.getString("code"), rsgroup.getString("duration"));
     DateTimeCodeBean.put("color"+rsgroup.getString("code"), (rsgroup.getString("color")==null || rsgroup.getString("color").equals(""))?bgcolordef:rsgroup.getString("color") );
   } 
%>

<table BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%">
<tr>
  <td VALIGN="BOTTOM" HEIGHT="20"> 
 
    <table BORDER="0" CELLPADDING="0" CELLSPACING="0" height="20">
      <tr>
        <td></td><td rowspan="2" BGCOLOR="ivory" ALIGN="MIDDLE" nowrap height="20"><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a href="receptionistcontrol.jsp?year=<%=curYear%>&month=<%=curMonth%>&day=<%=curDay%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=day&dboperation=searchappointmentday" TITLE='View your daily schedule' OnMouseOver="window.status='View your daily schedule' ; return true"> 
         &nbsp;&nbsp;Day&nbsp;&nbsp; </a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a href="receptionistcontrol.jsp?year=<%=year%>&month=<%=month%>&day=<%=day%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=month&dboperation=searchappointmentmonth"   TITLE='View your monthly template' OnMouseOver="window.status='View your monthly template' ; return true">Month</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a href="#" ONCLICK ="popupPage(550,800,'<%=resourcebaseurl%>');return false;" title="Manage Clinical Resource" >Resource</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a HREF="#" ONCLICK ="popupPage(550,760,'../demographic/search.htm');return false;"  TITLE='Search for patient records' OnMouseOver="window.status='Search for patient records' ; return true">Search</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a HREF="#" ONCLICK ="popupPage2('../report/reportindex.jsp');return false;"   TITLE='Generate a report' OnMouseOver="window.status='Generate a report' ; return true">Report</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a HREF="#" ONCLICK ="popupPage2('../billing/billingReportCenter.jsp??displaymode=billreport&providerview=<%=curUser_no%>');return false;" TITLE='Generate a billing report' onmouseover="window.status='Generate a billing report';return true">Billing</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a HREF="#" ONCLICK ="popupOscarRx(600,900,'../oscarMessenger/DisplayMessages.do?providerNo=<%=curUser_no%>&userName=<%=URLEncoder.encode(userfirstname+" "+userlastname)%>')">
         <oscarmessage:newMessage providerNo="<%=curUser_no%>"/></a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a HREF="#" ONCLICK ="popupOscarRx(600,900,'../oscarEncounter/IncomingConsultation.do?providerNo=<%=curUser_no%>&userName=<%=URLEncoder.encode(userfirstname+" "+userlastname)%>')">
         con</a></font>
         </td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
         <a href=# onClick ="popupPage(200,680,'receptionistpreference.jsp?provider_no=<%=curUser_no%>&start_hour=<%=startHour%>&end_hour=<%=endHour%>&every_min=<%=everyMin%>&mygroup_no=<%=mygroupno%>');return false;">Pref</a></font></td>
        <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
	         <a HREF="#" ONCLICK ="popupPage2('../dms/documentReport.jsp?function=provider&functionid=<%=curUser_no%>&curUser=<%=curUser_no%>');return false;" TITLE='View e-Document'>eDoc</a></font></td>
 <td></td><td rowspan="2" BGCOLOR="#C0C0C0" ALIGN="MIDDLE" nowrap><font FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
              <a HREF="#" ONCLICK ="popupPage2('../tickler/ticklerMain.jsp');return false;" TITLE='View Tickler'>Tickler</a></font></td>
 
        <td></td>
      </tr><tr>
        <td valign="bottom"><img src="../images/tabs_l_active_end_alone.gif" width="14" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_r_active_end.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_both_inactive.gif" width="15" height="20" border="0"></td>
        <td valign="bottom"><img src="../images/tabs_r_inactive_end.gif" width="17" height="20" border="0"></td>
      </tr>
    </table>

  </td>
  <form method="post" name="findprovider" onSubmit="findProvider(<%=year%>,<%=month%>,<%=day%>);return false;" target="apptReception" action="receptionistfindprovider.jsp">
  <td align="right" valign="bottom">
   <INPUT TYPE="text" NAME="providername" VALUE="" WIDTH="2" HEIGHT="10" border="0" size="10" maxlength="10">-
   <INPUT TYPE="SUBMIT" NAME="Go" VALUE="GO" onClick="findProvider(<%=year%>,<%=month%>,<%=day%>);return false;">
  </td></form>
</tr>
</table>

<table BORDER="0" CELLPADDING="1" CELLSPACING="0" WIDTH="100%" BGCOLOR="#C0C0C0">
  <tr><td>
    <table BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%">
      <tr BGCOLOR="ivory">
        <td nowrap>
         <a href="receptionistcontrol.jsp?year=<%=year%>&month=<%=month%>&day=<%=(day-1)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=day&dboperation=searchappointmentday">
         &nbsp;&nbsp;<img src="../images/previous.gif" WIDTH="10" HEIGHT="9" BORDER="0" ALT="View Previous DAY" vspace="2"></a> 
         <b><span CLASS=title><%=strDayOfWeek%>, <%=strYear%>-<%=strMonth%>-<%=strDay%></span></b>
         <a href="receptionistcontrol.jsp?year=<%=year%>&month=<%=month%>&day=<%=(day+1)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=day&dboperation=searchappointmentday">
         <img src="../images/next.gif" WIDTH="10" HEIGHT="9" BORDER="0" ALT="View Next DAY" vspace="2">&nbsp;&nbsp;</a>
         <a href=# onClick ="popupPage(310,430,'../share/CalendarPopup.jsp?urlfrom=../receptionist/receptionistcontrol.jsp&year=<%=strYear%>&month=<%=strMonth%>')">Calendar</a>
        </td>
        <TD ALIGN="center" width="33%"><% if(view==1) out.println("<a href='receptionistcontrol.jsp?year="+strYear+"&month="+strMonth+"&day="+strDay+"&view=0&displaymode=day&dboperation=searchappointmentday'>Group View</a>"); %></TD>
        <td ALIGN="RIGHT">
  <a href=# onClick = "popupPage(300,450,'receptionistchangemygroup.jsp?mygroup_no=<%=mygroupno%>' );return false;" title="Change your Group No.">Group:</a>
  <select name="mygroup_no" onChange="changeGroup(this)">
  <option value=".default">.default</option>
<% rsgroup = apptMainBean.queryResults("mygroup_no", "searchmygroupno");
 	 while (rsgroup.next()) { 
%>
  <option value="<%="_grp_"+rsgroup.getString("mygroup_no")%>" <%=mygroupno.equals(rsgroup.getString("mygroup_no"))?"selected":""%> ><%=rsgroup.getString("mygroup_no")%></option>
<% } %>
  
<% rsgroup = apptMainBean.queryResults("last_name", "searchprovider");
 	 while (rsgroup.next()) { 
%>
  <option value="<%=rsgroup.getString("provider_no")%>" <%=mygroupno.equals(rsgroup.getString("provider_no"))?"selected":""%> %> <%=rsgroup.getString("last_name")+", "+rsgroup.getString("first_name")%></option>
<%
 	 }
%>


</select>
<%
  if(request.getParameter("viewall")!=null && request.getParameter("viewall").equals("1") ) {
%>        
         <a href=# onClick = "review('0')" title="View providers available">Schedule View</a> &nbsp;|&nbsp; 
<% } else { %>         
         <a href=# onClick = "review('1')" title="View all providers in the group">View All</a> &nbsp;|&nbsp; 
<% } %>         
         <a href="../logout.jsp">Log Out <img src="../images/next.gif"  border="0" width="10" height="9" align="absmiddle"> &nbsp;</a> </td>
      </tr>

      <tr><td colspan="3">
        <table border="0" cellpadding="0" bgcolor="#486ebd" cellspacing="0" width="100%">
        <tr>
				<%
          int hourCursor=0, minuteCursor=0, depth=everyMin; //depth is the period, e.g. 10,15,30,60min.
          String am_pm=null;
          boolean bColor=true, bColorHour=true; //to change color 

   int iCols=0, iRows=0, iS=0,iE=0,iSm=0,iEm=0; //for each S/E starting/Ending hour, how many events
   int ih=0, im=0, iSn=0, iEn=0 ; //hour, minute, nthStartTime, nthEndTime, rowspan
   boolean bFirstTimeRs=true;
   boolean bFirstFirstR=true;

 	 String[] param =new String[2];
	 String strsearchappointmentday=request.getParameter("dboperation");
   ResultSet rs = null;

   StringBuffer hourmin = null;
   String [] param1 = new String[2];
   for(int nProvider=0;nProvider<numProvider;nProvider++) {
     param1[0] = strYear+"-"+strMonth+"-"+strDay;
     param1[1] = curProvider_no[nProvider];
     rsgroup = apptMainBean.queryResults(param1, "search_scheduledate_single");
     
     //viewall function 
     if(request.getParameter("viewall")==null || request.getParameter("viewall").equals("0") ) {if(!rsgroup.next() || rsgroup.getString("available").equals("0") ) continue;}
     bColor=bColor?false:true;
 %>
            <td valign="top" width="<%=1*100/numProvider%>%"> <!-- for the first provider's schedule -->
         
        <table border="0" cellpadding="0" bgcolor="#486ebd" cellspacing="0" width="100%"><!-- for the first provider's name -->
          <tr><td ALIGN="center" BGCOLOR="<%=bColor?"#bfefff":"silver"%>">
          <b><input type='radio' name='flipview' onClick="goFilpView('<%=curProvider_no[nProvider]%>')" title="Flip view"  >
          <a href=# onClick="goZoomView('<%=curProvider_no[nProvider]%>','<%=curProviderName[nProvider]%>')" title="zoom view" >
          <%=curProviderName[nProvider]%></a></b></td></tr>
          <tr><td valign="top">
        
        <!-- table for hours of day start --> 
        <table border="1" cellpadding="0" bgcolor="#486ebd" cellspacing="0" width="100%">
				<%
          bFirstTimeRs=true;
          bFirstFirstR=true;
  				param[0]=curProvider_no[nProvider];
	 				param[1]=year+"-"+month+"-"+day;//e.g."2001-02-02";
   				rs = apptMainBean.queryResults(param, strsearchappointmentday);

			    for(ih=startHour*60; ih<=(endHour*60+(60/depth-1)*depth); ih+=depth) { // use minutes as base
            hourCursor = ih/60;
            minuteCursor = ih%60;
            bColorHour=minuteCursor==0?true:false; //every 00 minute, change color
      
            //templatecode     
            if(DateTimeCodeBean.get(curProvider_no[nProvider]) != null) {       
	            int nLen = 24*60 / ((String) DateTimeCodeBean.get(curProvider_no[nProvider]) ).length();
	            int ratio = (hourCursor*60+minuteCursor)/nLen;
              hourmin = new StringBuffer(DateTimeCodeBean.get(curProvider_no[nProvider])!=null?((String) DateTimeCodeBean.get(curProvider_no[nProvider])).substring(ratio,ratio+1):" " );
            } else { hourmin = new StringBuffer(); }
        %>
          <tr>
            <td align="RIGHT" bgcolor="<%=bColorHour?"#3EA4E1":"#00A488"%>" width="5%" NOWRAP><b><font face="verdana,arial,helvetica" size="2"> 
             <a href=# onClick ="ts1('provider_no=<%=curProvider_no[nProvider]%>&bFirstDisp=<%=true%>&year=<%=strYear%>&month=<%=strMonth%>&day=<%=strDay%>&start_time=<%=(hourCursor>9?(""+hourCursor):("0"+hourCursor))+":"+ (minuteCursor<10?"0":"") +minuteCursor %>&end_time=<%=(hourCursor>9?(""+hourCursor):("0"+hourCursor))+":"+(minuteCursor+depth-1)%>&duration=<%=DateTimeCodeBean.get("duration"+hourmin.toString())%>');return false;" 
             title='<%=MyDateFormat.getTimeXX_XXampm(hourCursor +":"+ (minuteCursor<10?"0":"")+minuteCursor)%> - <%=MyDateFormat.getTimeXX_XXampm(hourCursor +":"+((minuteCursor+depth-1)<10?"0":"")+(minuteCursor+depth-1))%>' class="adhour">
             <%=(hourCursor<10?"0":"") +hourCursor+ ":"%><%=(minuteCursor<10?"0":"")+minuteCursor%>&nbsp;</a></font></b></td>
            <td width='1%' <%=DateTimeCodeBean.get("color"+hourmin.toString())!=null?("bgcolor="+DateTimeCodeBean.get("color"+hourmin.toString()) ):("bgcolor="+bgcolordef) %> title='<%=DateTimeCodeBean.get("description"+hourmin.toString())%>'><font color='<%=(DateTimeCodeBean.get("color"+hourmin.toString())!=null && !DateTimeCodeBean.get("color"+hourmin.toString()).equals(bgcolordef) )?"black":"black" %>'><%=hourmin.toString() %></font>
            </td>
				<%
          	while (bFirstTimeRs?rs.next():true) { //if it's not the first time to parse the standard time, should pass it by
          	  len = bFirstTimeRs&&!bFirstFirstR?lenLimitedS:lenLimitedL;
          	  
          	  iS=Integer.parseInt(rs.getString("start_time").substring(0,2));
        	    iSm=Integer.parseInt(rs.getString("start_time").substring(3,5));
         	    iE=Integer.parseInt(rs.getString("end_time").substring(0,2));
     	        iEm=Integer.parseInt(rs.getString("end_time").substring(3,5));
          	  if( (ih < iS*60+iSm) && (ih+depth-1)<iS*60+iSm ) { //appt after this time slot, iS not in this time slot (both start&end), get to the next period
          	  	bFirstTimeRs=false;
          	  	break;
          	  }
          	  if( (ih > iE*60+iEm) ) { //appt before this time slot (both start&end), get to the next period
          	  	bFirstTimeRs=true;
          	  	continue;
          	  }
         	    iRows=((iE*60+iEm)-ih)/depth+1; //to see if the period across an hour period
          	  String name = Misc.toUpperLowerCase(rs.getString("name"));
          	  int demographic_no = rs.getInt("demographic_no");
          	  String reason = rs.getString("reason");
          	  String notes = rs.getString("notes");
          	  String status = rs.getString("status");
          	  bFirstTimeRs=true;
        %>	    
            <td bgcolor=<%=status.indexOf('T')!=-1||status.indexOf('t')!=-1?"#FDFEC7":status.indexOf('P')!=-1?"#FFBBFF":status.indexOf('H')!=-1?"#00ee00":status.indexOf('B')!=-1?"#3ea4e1":status.indexOf('N')!=-1?"#cccccc":"#999999"%> rowspan="<%=iRows%>" <%=view==0?(len==lenLimitedL?"nowrap":""):"nowrap"%> >
            <%
              if(status.indexOf('t')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('t',' ').trim()%>&statusch=T&year=<%=year%>&month=<%=month%>&day=<%=day%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="To Do" >
            <img src="../images/starbill.gif" border="0" height="10"></a>
            <%
              } else if(status.indexOf('T')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('T',' ').trim()%>&statusch=H&year=<%=year%>&month=<%=month%>&day=<%=day%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="Daysheet Printed" >
            <img src="../images/todo.gif" border="0" height="10"></a>
            <%
              } else if(status.indexOf('P')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('P',' ').trim()%>&statusch=N&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=rs.getString("start_time")%>&demographic_no=<%=demographic_no==0?"0":(""+demographic_no)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="Picked" >
            <img src="../images/picked.gif" border="0" ></a>
            <%
              } else if(status.indexOf('H')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('H',' ').trim()%>&statusch=P&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=rs.getString("start_time")%>&demographic_no=<%=demographic_no==0?"0":(""+demographic_no)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="Here" >
            <img src="../images/here.gif" border="0" ></a>
            <%
              } else if(status.indexOf('N')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('N',' ').trim()%>&statusch=C&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=rs.getString("start_time")%>&demographic_no=<%=demographic_no==0?"0":(""+demographic_no)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="No Show" >
            <img src="../images/noshow.gif" border="0" ></a>
            <%
              } else if(status.indexOf('C')!=-1) {
            %>
            <a href="receptionistcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&status=<%=status.replace('C',' ').trim()%>&statusch=t&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=rs.getString("start_time")%>&demographic_no=<%=demographic_no==0?"0":(""+demographic_no)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=addstatus&dboperation=updateapptstatus&viewall=<%=request.getParameter("viewall")==null?"0":(request.getParameter("viewall"))%>"; title="Cancelled" >
            <img src="../images/cancel.gif" border="0" ></a>
            <%
              } else if(status.indexOf('B')!=-1) {
            %>
            <img src="../images/billed.gif" border="0"  title="Billed">
            <%
              } else {
            %>
            &nbsp;
            <%
              } 
            %>
<%--|--%>
        <%
        			if(demographic_no==0) {
        %>
        		<a href=# onClick ="popupPage(360,680,'../appointment/appointmentcontrol.jsp?appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=iS+":"+iSm%>&demographic_no=0&displaymode=edit&dboperation=search');return false;" title="<%=iS+":"+(iSm>10?"":"0")+iSm%>-<%=iE+":"+iEm%>
reason: <%=Misc.htmlEscape(reason)%>
notes: <%=Misc.htmlEscape(notes)%>" >
            .<%=(view==0?(name.length()>len?name.substring(0,len):name):name).toUpperCase()%></font></a></td>
<%
        			} else {
        			  //System.out.println(name+" / " +demographic_no);
%>
        		<a href=# onClick ="tsr('appointment_no=<%=rs.getString("appointment_no")%>&provider_no=<%=curProvider_no[nProvider]%>&year=<%=year%>&month=<%=month%>&day=<%=day%>&start_time=<%=iS+":"+iSm%>&demographic_no=<%=demographic_no%>');return false;" title="<%=name%>
reason: <%=Misc.htmlEscape(reason)%>
notes: <%=Misc.htmlEscape(notes)%>" >
        		<%=view==0?(name.length()>len?name.substring(0,len):name):name%></a>
        		<% if(len==lenLimitedL || view!=0) {%>
            <a href=# onClick="popupPage2('../demographic/demographiccontrol.jsp?demographic_no=<%=demographic_no%>&displaymode=edit&dboperation=search_detail');return false;" title="Master file">
            | M </a>
<% } %>
        		</font></td>
<% 
        			}
        			bFirstFirstR = false;
          	}
            out.println("<td width='1'></td></tr>"); //no grid display
          }
%>        

          </table> <!-- end table for each provider schedule display --> 

         </td></tr>
          <tr><td ALIGN="center" BGCOLOR="<%=bColor?"#bfefff":"silver"%>">
          <b><input type='radio' name='flipview' onClick="goFilpView('<%=curProvider_no[nProvider]%>')" title="Flip view"  >
          <a href=# onClick="goZoomView('<%=curProvider_no[nProvider]%>','<%=curProviderName[nProvider]%>')" title="zoom view" >
          <%=curProviderName[nProvider]%></a></b></td></tr>

       </table><!-- end table for each provider name -->

            </td>
 <%
   } //end of display team a, etc.    
   apptMainBean.closePstmtConn();
 %>
 

          </tr>
        </table>        <!-- end table for the whole schedule row display --> 


        </td>
      </tr>
      
      <tr><td colspan="3">
      <table BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="100%">
  			<tr>
        	<td BGCOLOR="ivory" width="50%">
         	 <a href="receptionistcontrol.jsp?year=<%=year%>&month=<%=month%>&day=<%=(day-1)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=day&dboperation=searchappointmentday">
         	 &nbsp;&nbsp;<img src="../images/previous.gif" WIDTH="10" HEIGHT="9" BORDER="0" ALT="View Previous DAY" vspace="2"></a> 
           <b><span CLASS=title><%=strDayOfWeek%>, <%=strYear%>-<%=strMonth%>-<%=strDay%></span></b>
           <a href="receptionistcontrol.jsp?year=<%=year%>&month=<%=month%>&day=<%=(day+1)%>&view=<%=view==0?"0":("1&curProvider="+request.getParameter("curProvider")+"&curProviderName="+request.getParameter("curProviderName") )%>&displaymode=day&dboperation=searchappointmentday">
           <img src="../images/next.gif" WIDTH="10" HEIGHT="9" BORDER="0" ALT="View Next DAY" vspace="2">&nbsp;&nbsp;</a></td>
        	<td ALIGN="RIGHT" BGCOLOR="Ivory">
           <a href="../logout.jsp">Log Out <img src="../images/next.gif"  border="0" width="10" height="9" align="absmiddle"> &nbsp;</a> </td>
  			</TR>
			</table>
		</td></tr>
	
	</table>
	</td></tr>
</table>

</body>
</html>
